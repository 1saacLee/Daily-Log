## 实时阴影渲染

### 复习：Shadow Mapping
- shadowmap的流程是先从点光源的位置向场景投射，记录下摄像机在点光源处的最小深度，形成shadowmap，在从真正的摄像机的位置开始渲染，深度大于该位置对应的shadowmap的像素就都渲染成黑色就可以
- shadowmap的深度是从光源看过去的深度，与屏幕空间的深度可能并不一致
- shadowmap的做法有两个主要的缺点：自遮挡和锯齿

#### 自遮挡
- 自遮挡出现的原因是因为：物体中场景的深度总是离散的浮点数，在场景中离光源较远的pixel可能覆盖率若干个Texel，所以在以pixel采样深度的时候，无法保证采样到哪个Texel上，所以就会出现：一些像素采样小于实际深度，另一些大于实际深度
    ![avatar](../pictures/GAMES202/self-occlusion.jpg)
    这里箭头所指的方向就是摄像机的观察方向，黑色部分是可见部分部分，因为他们的shadowmap在实际深度下面，黄色直线就是错误的阴影部分
    ![avatar](../pictures/GAMES202/self-occlusion.png)
    这里同样是一个例子
- **解决方案一**：
是给shadowmap加一个很小的bias，让shadowmap整体下移一部分，或者摄像机视角的深度上移一部分就可以解决。bias也不能太大，否则会出现阴影的错位
- **解决方案2**：记录从光源看去深度的最小值和次小值，以它们的平均值作为shadowmap的实际深度值

#### 走样
- 锯齿出现的原因是因为：从点光源向某个场景渲染的时候，最近的物体处在视锥的靠前的位置，但阴影会渲染在靠后的背景上，因此物体的一个pixel可能会遮挡住背景上的若干个pixel，表现出来就是阴影的锯齿很明显

- 解决方案一：
    PCF

- 解决方案二：
    PCSS